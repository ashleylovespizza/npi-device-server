net = require 'net'

class Server

  DEFAULT_PORT: 12311
  DEFAULT_ADDR: "127.0.0.1"

  clients = []

  # start our server and bind various events to methods
  start: () ->

    @server = net.createServer (c) =>
      console.log "Connection received."
      @addClient(c)

      c.write "WELCOME TO NO PANTS ISLAND"

      # on server close
      c.on 'end', () =>
        @removeClient(c)
        c.destroy()

      # on data received
      c.on 'data', (data) =>

        if String(data).trim() == 'length'
          c.write "Clients: " + clients.length

        cleanWrite = () ->
          if client != c
            client.write data
                    
        cleanWrite(data) for client in clients
        console.log "message: #{data}"


    @server.listen @DEFAULT_PORT, () ->
      console.log "Server started."


  removeClient: (c) ->
    (if c == client
      clients.splice(_i, 1)) for client in clients
    console.log "Client removed. Now holding " + clients.length + " clients."

  addClient: (c) ->
    clients.push(c)

exports.Server = Server